<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Im√≥vel - Kleiton Falc√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #carregando { display: flex; }
        #conteudo { display: none; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900">

    <div id="carregando" class="fixed inset-0 bg-white z-[100] flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 font-bold animate-pulse">Buscando detalhes do im√≥vel...</p>
    </div>

    <div id="conteudo" class="max-w-md mx-auto bg-white min-h-screen pb-28 shadow-2xl relative">
        
        <div class="bg-slate-800 text-white text-[10px] py-2 px-4 text-center uppercase tracking-widest font-bold">
            Im√≥vel de Parceiro ‚Ä¢ Curadoria Kleiton Falc√£o
        </div>

        <div class="relative h-80 bg-slate-200 flex overflow-hidden">
            <img id="imovel-foto" src="" class="w-full h-full object-cover">
        </div>

        <div class="p-6 bg-white rounded-t-[32px] -mt-10 relative z-10">
            
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Destaque</span>
                <span class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Venda</span>
            </div>

            <h1 id="imovel-titulo" class="text-2xl font-bold text-slate-800 leading-tight mb-1">...</h1>
            <p class="flex items-center text-slate-500 text-sm mb-4">
                <i class="bi bi-geo-alt-fill mr-1 text-blue-600"></i> <span id="imovel-local">Localiza√ß√£o</span>
            </p>

            <div class="mb-6">
                <span id="imovel-preco" class="text-3xl font-black text-slate-900 font-mono">...</span>
            </div>

            <div class="grid grid-cols-3 gap-2 mb-8 border-y py-5 border-slate-100">
                <div class="text-center">
                    <span id="imovel-quartos" class="block font-bold text-slate-800 text-lg leading-none">0</span>
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Quartos</span>
                </div>
                <div class="text-center border-x border-slate-100">
                    <span id="imovel-vagas" class="block font-bold text-slate-800 text-lg leading-none">0</span>
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Vagas</span>
                </div>
                <div class="text-center">
                    <span id="imovel-area" class="block font-bold text-slate-800 text-lg leading-none">0m¬≤</span>
                    <span class="text-[10px] text-slate-400 uppercase font-bold">√Årea</span>
                </div>
            </div>

            <div class="mb-10">
                <h3 class="font-bold text-slate-800 mb-3 border-l-4 border-blue-600 pl-2 uppercase text-xs tracking-wider">Descri√ß√£o do Im√≥vel</h3>
                <div id="imovel-descricao" class="text-slate-600 leading-relaxed text-sm whitespace-pre-line text-justify">
                    ...
                </div>
            </div>

            <div class="bg-blue-600 p-4 rounded-2xl text-white shadow-lg shadow-blue-100">
                <p class="text-[8px] font-bold text-blue-200 uppercase tracking-[0.2em] mb-2">Atendimento Exclusivo</p>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-blue-600 font-bold text-lg overflow-hidden border-2 border-white/30" id="corretor-sigla">
                        KF
                    </div>
                    <div>
                        <p id="corretor-nome" class="font-bold text-base leading-tight">...</p>
                        <p id="corretor-creci" class="text-[10px] text-blue-100 font-medium mb-1">Corretor de Im√≥veis</p>
                        
                        <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
                            <span id="corretor-whats" class="text-[10px] text-white italic flex items-center gap-1.5 opacity-95 font-medium">
                                <i class="bi bi-telephone-fill text-[9px] text-blue-200"></i> ...
                            </span>
                            <span id="corretor-email" class="text-[10px] text-white italic flex items-center gap-1.5 opacity-95 font-medium border-l border-white/30 pl-3">
                                <i class="bi bi-envelope-fill text-[9px] text-blue-200"></i> ...
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-md border-t border-slate-100 max-w-md mx-auto z-50">
            <a id="btn-whats-link" href="#" target="_blank" class="bg-green-500 hover:bg-green-600 text-white w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 text-lg">
                <i class="bi bi-whatsapp"></i>
                Tenho interesse neste im√≥vel
            </a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://wjdqfutxtvhwdhgyqrqz.supabase.co";
        const SUPABASE_KEY = "sb_publishable_P4BgLLoKVHb0gRQ5ytOTwA_J5ELFbZ9";

        async function carregarImovel() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (!id) {
                document.body.innerHTML = "<div class='p-10 text-center font-bold'>Im√≥vel n√£o encontrado ou link inv√°lido.</div>";
                return;
            }

            try {
                // 1. Busca dados do Im√≥vel
                const res = await fetch(`${SUPABASE_URL}/rest/v1/imoveis?id=eq.${id}`, {
                    headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
                });
                const dados = await res.json();
                const imovel = dados[0];

                if (!imovel) throw new Error("Im√≥vel n√£o existe no banco.");

                // 2. Busca dados do Corretor
                const resCorretor = await fetch(`${SUPABASE_URL}/rest/v1/perfis?email=eq.${imovel.corretor_id}`, {
                    headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
                });
                const dadosCorretor = await resCorretor.json();
                const corretor = dadosCorretor[0] || {};

                // 3. Preenche a p√°gina
                document.getElementById("imovel-foto").src = imovel.foto_url;
                document.getElementById("imovel-titulo").innerText = imovel.titulo;
                document.getElementById("imovel-preco").innerText = imovel.preco;
                document.getElementById("imovel-area").innerText = imovel.area + (imovel.area.includes('m') ? '' : 'm¬≤');
                document.getElementById("imovel-quartos").innerText = imovel.quartos;
                document.getElementById("imovel-vagas").innerText = imovel.vagas;
                document.getElementById("imovel-descricao").innerText = imovel.descricao;
                document.getElementById("imovel-local").innerText = (corretor.cidade || "Santa Catarina") + " / " + (corretor.estado || "SC");

                // Dados do Corretor no Card
                document.getElementById("corretor-nome").innerText = corretor.nome || imovel.corretor_nome;
                document.getElementById("corretor-creci").innerText = `Corretor de Im√≥veis ‚Ä¢ CRECI ${corretor.creci || '---'}`;
                document.getElementById("corretor-whats").innerHTML = `<i class="bi bi-telephone-fill text-blue-200"></i> ${corretor.telefone || imovel.corretor_whats}`;
                document.getElementById("corretor-email").innerHTML = `<i class="bi bi-envelope-fill text-blue-200"></i> ${corretor.email || imovel.corretor_id}`;
                
                // 4. Link do WhatsApp com Mensagem Formatada
                const whatsFinal = (corretor.telefone || imovel.corretor_whats).replace(/\D/g, '');
                const urlAtual = window.location.href;
                
                // Mensagem com quebras de linha (\n) e negrito (*)
                const msg = encodeURIComponent(
                    `Ol√°! Vi o im√≥vel "${imovel.titulo}" na sua vitrine.\n\n` +
                    `üìå *C√≥digo:* ID-${imovel.id}\n` +
                    `üîó *Link:* ${urlAtual}\n\n` +
                    `Gostaria de agendar uma visita ou receber mais informa√ß√µes.`
                );

                document.getElementById("btn-whats-link").href = `https://wa.me/55${whatsFinal}?text=${msg}`;

                // Finaliza carregamento
                document.getElementById("carregando").style.display = "none";
                document.getElementById("conteudo").style.display = "block";
                document.title = imovel.titulo;

            } catch (error) {
                console.error(error);
                document.getElementById("carregando").innerHTML = "<div class='p-6 text-center text-red-600 font-bold'>Erro ao carregar o im√≥vel. Certifique-se que o c√≥digo est√° correto.</div>";
            }
        }

        carregarImovel();
    </script>
</body>
</html>
